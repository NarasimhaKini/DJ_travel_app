{% load static %}

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Travel Blog Map</title>
  <link rel="stylesheet" href="{% static 'places/styles.css' %}">
  <!-- Bootstrap CDN optional for quick responsiveness -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #map { height: 60vh; width:100%; }
    .place-list { max-height: 40vh; overflow:auto; }
    .photo-thumb { width:100px; height:70px; object-fit:cover; margin:4px; cursor:pointer; }
  </style>
</head>
<body>
<div class="container-fluid p-2">
  <div class="row">
    <div class="col-md-8">
      <div id="map"></div>
    </div>
    <div class="col-md-4">
      <h4>Places</h4>
      <div class="place-list list-group" id="places-list"></div>
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photosModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- thumbnails -->
      </div>
    </div>
  </div>
</div>

<script>
  const GOOGLE_API_KEY = "{{ GOOGLE_MAPS_API_KEY }}"; // set in view context via settings or template context processor
  function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), { zoom: 2, center: {lat:0, lng:0} });

    fetch('{% url "places-json" %}')
    .then(res => res.json())
    .then(data => {
      const bounds = new google.maps.LatLngBounds();
      data.places.forEach(p => {
        const pos = {lat: p.lat, lng: p.lng};
        const marker = new google.maps.Marker({
          position: pos,
          map,
          title: p.name
        });
        bounds.extend(pos);
        marker.addListener('click', () => openPhotosModal(p));
        // add to list
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `<strong>${p.name}</strong><div>${p.description || ''}</div>`;
        item.onclick = (e) => { e.preventDefault(); map.setCenter(pos); map.setZoom(12); openPhotosModal(p); };
        document.getElementById('places-list').appendChild(item);
      });
      if (!bounds.isEmpty()) map.fitBounds(bounds);
    });
  }

  function openPhotosModal(place) {
    document.getElementById('modalTitle').innerText = place.name;
    const body = document.getElementById('modalBody');
    body.innerHTML = '';
    if (place.photos && place.photos.length) {
      place.photos.forEach(ph => {
        const img = document.createElement('img');
        img.src = ph.url;
        img.alt = ph.caption || '';
        img.className = 'photo-thumb';
        img.onclick = () => window.open(ph.url, '_blank');
        body.appendChild(img);
      });
    } else {
      body.innerHTML = '<p>No photos</p>';
    }
    var modal = new bootstrap.Modal(document.getElementById('photosModal'));
    modal.show();
  }
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap">
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
